<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
  <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
  <script src="https://unpkg.com/jquery/dist/jquery.min.js"></script>
</head>
<body>
  <ons-navigator id="myNavigator">
    <ons-page>
      <ons-toolbar>
        <div class="center">Navigator+Tabbar</div>
      </ons-toolbar>
  
      <ons-tabbar position="auto">
        <ons-tab page="home.html" active icon="fa-home" label="Home"></ons-tab>
        <ons-tab icon="fa-cheese" label="Cards" badge="3" page="cards.html"></ons-tab>
        <ons-tab icon="fa-paperclip" label="Pages" badge="3" page="pages.html"></ons-tab>
        <ons-tab icon="ion-ios-cog" label="Settings" page="settings.html"></ons-tab>
      </ons-tabbar>
    </ons-page>
  </ons-navigator>
  
  <template id="home.html">
    <ons-page>
      <h2>Home</h2>
      <div style="text-align: center">
        <br>
        <ons-button onclick="myNavigator.pushPage('pageNav1.html')">
          Push Page
        </ons-button>
      </div>
    </ons-page>
  </template>
  
  <template id="pageNav1.html">
    <ons-page id="pageNav1">
      <ons-toolbar>
        <div class="left">
          <ons-back-button>Back</ons-back-button>
        </div>
        <div class="center"></div>
      </ons-toolbar>
  
      <div style="text-align: center">
        <h1>Custom Page</h1>
        <p>
          <ons-input modifier="underbar" placeholder="Title" float></ons-input>
        </p>
        <ons-button onclick="customPush()">
          Push Page
        </ons-button>
        <ons-button onclick="myNavigator.popPage()">
          Pop Page
        </ons-button>
      </div>
    </ons-page>
  </template>
  
  <template id="cards.html">
    <ons-page>
      <h2>Cards</h2>
      <ons-list-title>Card List</ons-list-title>
      <ons-list>
        <ons-list-item onclick="customPush2(event,'j1','json/j1.json')">Card One</ons-list-item>
        <ons-list-item onclick="customPush2(event,'j2','json/j2.json')">Card Two</ons-list-item>
        <ons-list-item onclick="customPush2(event,'j3','json/j3.json')">Card Three</ons-list-item>
      </ons-list>
    </ons-page>
  </template>
  
  <template id="pageNav2.html">
    <ons-page id="pageNav2">
      <ons-toolbar>
        <div class="left">
          <ons-back-button>Back</ons-back-button>
        </div>
      </ons-toolbar>
  
      <ons-card>
        <div class="title"></div>
        <div class="content">
          <ons-list class="list1">
            <ons-list-header></ons-list-header>
            <ons-list-item class="item1"></ons-list-item>
            <ons-list-item class="item2"></ons-list-item>
          </ons-list>
          <ons-list>
            <ons-list-header>Bindings</ons-list-header>
            <ons-list-item>Vue</ons-list-item>
            <ons-list-item>Angular</ons-list-item>
            <ons-list-item>React</ons-list-item>
          </ons-list>
        </div>
      </ons-card>
    </ons-page>
  </template>
  
  <template id="pages.html">
    <!-- 外部ページへのリンク -->
    <ons-page>
      <h2>Pages</h2>
      <ons-list-title>Page List</ons-list-title>
      <ons-list>
        <ons-list-item onclick="customPush3(event,'https://dolce-meow.net/beauty/')">dolce meow</ons-list-item>
        <ons-list-item onclick="customPush3(event,'https://dolce-meow.net/market/')">market</ons-list-item>
        <ons-list-item onclick="customPush3(event,'https://shambeel.com/')">shambeel</ons-list-item>
        <ons-list-item onclick="customPush3(event,'https://kobe-nagasawa.co.jp/fountainpen/')">万年筆</ons-list-item>
        <ons-list-item onclick="customPush3(event,'https://www.toyota.co.jp/')">トヨタ</ons-list-item>
        <ons-list-item onclick="customPush3(event,'https://www.muji.com/jp/ja/store')">無印</ons-list-item>
        <ons-list-item onclick="customPush3(event,'https://inocchii.github.io/daily_report/www/')">デモアプリ（日報）</ons-list-item>
        <ons-list-item onclick="customPush3(event,'https://inocchii.github.io/test_vue_2-1/')">テスト（Vue No.2.1）</ons-list-item>
        <ons-list-item onclick="customPush3(event,'https://inocchii.github.io/test_vue_4-5/')">テスト（Vue No.4.5）</ons-list-item>
        <ons-list-item onclick="customPush3(event,'https://inocchii.github.io/test_vue_5-/')">テスト（Vue No.5）</ons-list-item>
      </ons-list>
    </ons-page>
  </template>

  <template id="pageNav3.html">
    <ons-page id="pageNav3">
      <ons-toolbar>
        <div class="left">
          <ons-back-button>Back</ons-back-button>
        </div>
        <div class="center"></div>
      </ons-toolbar>
      <iframe referrerpolicy="same-origin" style="border:0px;width:100%;height:100%"></iframe>
    </ons-page>
  </template>
   
  <template id="settings.html">
    <ons-page>
      <h2>Settings</h2>
    </ons-page>
  </template>

  <script>
  document.addEventListener('init', function (event) {
    if (event.target.id === 'pageNav1') {
      let title = event.target.data && event.target.data.title ? event.target.data.title : 'Custom Page';
      event.target.querySelector('ons-toolbar div.center').textContent = title;
    }

    if (event.target.id === 'pageNav2') {
      // data にセットされた値を使ってリストに表示。
      let cardTitle = event.target.data && event.target.data.cardTitle ? event.target.data.cardTitle : 'not title';
      let localId   = event.target.data && event.target.data.localId ? event.target.data.localId : 'no id';
      let jsonUrl   = event.target.data && event.target.data.jsonUrl ? event.target.data.jsonUrl : 'no url';
      event.target.querySelector('ons-card div.title').textContent = cardTitle;
      event.target.querySelector('ons-card ons-list.list1 ons-list-header').textContent = cardTitle;
      event.target.querySelector('ons-card ons-list.list1 ons-list-item.item1').textContent = localId;
      event.target.querySelector('ons-card ons-list.list1 ons-list-item.item2').textContent = jsonUrl;

      try {
        // ローカルストレージに存在すれば取得
        console.log("using localStorage id="+localId+" jsonUrl="+jsonUrl);
        let myStorage = localStorage;
        let myJsonStr = myStorage.getItem(localId);
        console.log("get localStorage myJsonStr="+myJsonStr);

        // 指定URLから新しいJSONを取得
        let xhr = new XMLHttpRequest();
        xhr.open('GET',jsonUrl);
        // エラー処理
        xhr.onerror = () => {
          console.log("XMLHttpRequest failed ! jsonUrl="+jsonUrl+" response=".xhr.response);
        }
        // 正常取得処理
        xhr.onload = () => {
          try {
            let newJsonStr = xhr.response;
            // 内容が正しいかの検証が必要
            let newJson = JSON.parse(newJsonStr);
            // ローカルストレージと異なれば格納
            if ( myJsonStr != newJsonStr ) {
              console.log("myJson is old ! New="+newJsonStr);
              myStorage.setItem(localId,newJsonStr);
            } else {
              console.log("myJson is not old !");
            }
            myJsonStr = myStorage.getItem(localId);
            let myJson = JSON.parse(myJsonStr);
            Object.keys(myJson).forEach(function (key) {
              console.log("key:"+key+" val:"+myJson[key]);
            });
          } catch (error) {
            console.log("exception error="+error);
          }
        }
        xhr.send();
      } catch (error) {
        console.log("exception error="+error);
      }
    }
    if (event.target.id === 'pageNav3') {
      let pageTitle = event.target.data && event.target.data.pageTitle ? event.target.data.pageTitle : 'Custom Page';
      event.target.querySelector('ons-toolbar div.center').textContent = pageTitle;
      console.log("iframe "+event.target.querySelector('iframe').src);
      let pageUrl   = event.target.data && event.target.data.pageUrl ? event.target.data.pageUrl : '';
      event.target.querySelector('iframe').src = pageUrl;
    }
  });
  
  var customPush = function () {
    myNavigator.pushPage('pageNav1.html', { data: { title: myNavigator.topPage.querySelector('ons-input').value } })
  };
  
  var customPush2 = function (event,argLocalId,argUrl) {
    myNavigator.pushPage('pageNav2.html'
      , { data: { cardTitle: event.target.textContent ,localId: argLocalId ,jsonUrl: argUrl } }
    )
  };

  var customPush3 = function (event,argUrl) {
    console.log("event "+event.target+" url"+argUrl);
    myNavigator.pushPage('pageNav3.html'
      , { data: { pageTitle: event.target.textContent ,pageUrl: argUrl } }
    )
  };
  </script>
</body>
</html>